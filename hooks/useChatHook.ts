import { useCallback, useEffect, useRef, useState } from 'react'
import toast from 'react-hot-toast'
import axios from 'axios'
import { v4 as uuid } from 'uuid'
import { DefaultPersonas } from '@/constants/persona'
import { ChatGPInstance } from '@/components/chat'

enum StorageKeys {
  Chat_List = 'chatList',
  Chat_Current_ID = 'chatCurrentID'
}

const uploadFiles = async (files: File[]) => {
  let formData = new FormData()

  files.forEach((file) => {
    formData.append('files', file)
  })
  const { data } = await axios<any>({
    method: 'POST',
    url: '/api/document/upload',
    data: formData,
    timeout: 1000 * 60 * 5
  })
  return data
}

let isInit = false

const useChatHook = () => {
  const messagesMap = useRef<Map<string, ChatMessage[]>>(new Map<string, ChatMessage[]>())

  const chatRef = useRef<ChatGPInstance>(null)

  const [currentChat, setCurrentChat] = useState<Chat | undefined>(undefined)

  const [chatList, setChatList] = useState<Chat[]>([])

  const [personas, setPersonas] = useState<Persona[]>([])

  const [editPersona, setEditPersona] = useState<Persona | undefined>()

  const [isOpenPersonaModal, setIsOpenPersonaModal] = useState<boolean>(false)

  const [personaModalLoading, setPersonaModalLoading] = useState<boolean>(false)

  const [openPersonaPanel, setOpenPersonaPanel] = useState<boolean>(false)

  const [personaPanelType, setPersonaPanelType] = useState<string>('')

  const onOpenPersonaPanel = (type: string = 'chat') => {
    setPersonaPanelType(type)
    setOpenPersonaPanel(true)
  }

  const onClosePersonaPanel = useCallback(() => {
    setOpenPersonaPanel(false)
  }, [setOpenPersonaPanel])

  const onOpenPersonaModal = () => {
    setIsOpenPersonaModal(true)
  }

  const onClosePersonaModal = () => {
    setEditPersona(undefined)
    setIsOpenPersonaModal(false)
  }

  const onChangeChat = useCallback(
    (chat: Chat) => {
      const oldMessages = chatRef.current?.getConversation() || []
      const newMessages = messagesMap.current.get(chat.id) || []
      chatRef.current?.setConversation(newMessages)
      chatRef.current?.focus()
      messagesMap.current.set(currentChat?.id!, oldMessages)
      setCurrentChat(chat)
    },
    [currentChat?.id]
  )

  const onCreateChat = useCallback(
    (persona: Persona) => {
      const id = uuid()
      const newChat: Chat = {
        id,
        persona: persona
      }

      setChatList((state) => {
        return [...state, newChat]
      })

      onChangeChat(newChat)
      onClosePersonaPanel()
    },
    [setChatList, onChangeChat, onClosePersonaPanel]
  )

  const onDeleteChat = (chat: Chat) => {
    const index = chatList.findIndex((item) => item.id === chat.id)
    chatList.splice(index, 1)
    setChatList([...chatList])
    if (currentChat?.id === chat.id) {
      setCurrentChat(chatList[0])
    }
    if (chatList.length === 0) {
      onOpenPersonaPanel('chat')
    }
  }

  const onCreatePersona = async (values: any) => {
    const { type, name, prompt, files } = values
    const persona: Persona = {
      id: uuid(),
      role: 'system',
      name,
      prompt,
      key: ''
    }

    if (type === 'document') {
      try {
        setPersonaModalLoading(true)
        const data = await uploadFiles(files)
        persona.key = data.key
      } catch (e) {
        console.log(e)
        toast.error('Error uploading files')
      } finally {
        setPersonaModalLoading(false)
      }
    }

    setPersonas((state) => {
      const index = state.findIndex((item) => item.id === editPersona?.id)
      if (index === -1) {
        state.push(persona)
      } else {
        state.splice(index, 1, persona)
      }
      return [...state]
    })

    onClosePersonaModal()
  }

  const onEditPersona = async (persona: Persona) => {
    setEditPersona(persona)
    onOpenPersonaModal()
  }

  const onDeletePersona = (persona: Persona) => {
    setPersonas((state) => {
      const index = state.findIndex((item) => item.id === persona.id)
      state.splice(index, 1)
      return [...state]
    })
  }

  const saveMessages = (messages: ChatMessage[]) => {
    if (messages.length > 0) {
      localStorage.setItem(`ms_${currentChat?.id}`, JSON.stringify(messages))
    } else {
      localStorage.removeItem(`ms_${currentChat?.id}`)
    }
  }

  useEffect(() => {
    const chatList = (JSON.parse(localStorage.getItem(StorageKeys.Chat_List) || '[]') ||
      []) as Chat[]
    const currentChatId = localStorage.getItem(StorageKeys.Chat_Current_ID)

    if (chatList.length > 0) {
      const currentChat = chatList.find((chat) => chat.id === currentChatId)
      setChatList(chatList)

      chatList.forEach((chat) => {
        const messages = JSON.parse(localStorage.getItem(`ms_${chat?.id}`) || '[]') as ChatMessage[]
        messagesMap.current.set(chat.id!, messages)
      })

      onChangeChat(currentChat || chatList[0])
    } else {
      onCreateChat(DefaultPersonas[0])
    }

    return () => {
      document.body.removeAttribute('style')
      localStorage.setItem(StorageKeys.Chat_List, JSON.stringify(chatList))
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [])

  useEffect(() => {
    if (currentChat) {
      localStorage.setItem(StorageKeys.Chat_Current_ID, currentChat?.id)
    }
  }, [currentChat])

  useEffect(() => {
    localStorage.setItem(StorageKeys.Chat_List, JSON.stringify(chatList))
  }, [chatList])

  useEffect(() => {
    console.log('load persona from local storage')
    const loadedPersonas = JSON.parse(localStorage.getItem('Personas') || '[]') as Persona[]
    const updatedPersonas = loadedPersonas.map((persona) => {
      if (!persona.id) {
        persona.id = uuid()
      }
      return persona
    })
    setPersonas(updatedPersonas)
  }, [])

  useEffect(() => {
    localStorage.setItem('Personas', JSON.stringify(personas))
  }, [personas])

  useEffect(() => {
    if (isInit && !openPersonaPanel && chatList.length === 0) {
      onCreateChat(DefaultPersonas[0])
    }
    isInit = true
  }, [chatList, openPersonaPanel, onCreateChat])

  return {
    DefaultPersonas,
    chatRef,
    currentChat,
    chatList,
    personas,
    editPersona,
    isOpenPersonaModal,
    personaModalLoading,
    openPersonaPanel,
    personaPanelType,
    onOpenPersonaModal,
    onClosePersonaModal,
    setCurrentChat,
    onCreateChat,
    onDeleteChat,
    onChangeChat,
    onCreatePersona,
    onDeletePersona,
    onEditPersona,
    saveMessages,
    onOpenPersonaPanel,
    onClosePersonaPanel
  }
}

export default useChatHook
